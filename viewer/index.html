<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hook Events Log Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
    background: #0d1117;
    color: #c9d1d9;
    height: 100vh;
    overflow: hidden;
  }

  /* Header */
  .header {
    background: #161b22;
    border-bottom: 1px solid #30363d;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    z-index: 100;
  }
  .header h1 {
    font-size: 16px;
    color: #58a6ff;
    white-space: nowrap;
  }
  .header select, .header button {
    font-family: inherit;
    font-size: 12px;
    background: #21262d;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
  }
  .header select:hover, .header button:hover { border-color: #58a6ff; }
  .header button.active { background: #1f6feb; border-color: #1f6feb; color: #fff; }
  .header .spacer { flex: 1; }

  /* Stat Bar (replaces Summary Cards) */
  .stat-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 20px;
    background: #161b22;
    border-bottom: 1px solid #30363d;
    font-size: 13px;
    flex-wrap: wrap;
  }
  .stat-bar .stat {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #8b949e;
  }
  .stat-bar .stat .val { color: #f0f6fc; font-weight: 600; }
  .stat-bar .stat .val.live { color: #3fb950; }
  .stat-bar .stat .val.stale { color: #d29922; }
  .stat-bar .stat .val.warn { color: #ff4444; }
  .stat-bar .stat .val.caution { color: #ffbb33; }
  .stat-bar .info-icon {
    cursor: help;
    color: #484f58;
    font-size: 12px;
    margin-left: 1px;
  }
  .stat-bar .info-icon:hover { color: #8b949e; }
  .stat-bar .separator { color: #30363d; }

  /* Main Layout */
  .main {
    display: flex;
    gap: 16px;
    padding: 12px 20px;
    height: calc(100vh - 90px);
    overflow: hidden;
  }
  .left { width: 40%; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
  .right { width: 60%; display: flex; flex-direction: column; overflow: hidden; }

  /* Panels */
  .panel {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .panel-title {
    font-size: 12px;
    font-weight: 600;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 14px;
    border-bottom: 1px solid #30363d;
    background: #0d1117;
    flex-shrink: 0;
  }
  .panel-body {
    padding: 6px;
    overflow-y: auto;
    flex: 1;
  }

  /* Scrollbar */
  .panel-body::-webkit-scrollbar, .tab-content::-webkit-scrollbar { width: 6px; }
  .panel-body::-webkit-scrollbar-track, .tab-content::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb, .tab-content::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
  .panel-body::-webkit-scrollbar-thumb:hover, .tab-content::-webkit-scrollbar-thumb:hover { background: #484f58; }

  /* Session Cards (compact) */
  .session-card {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 6px 10px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .session-card:hover { border-color: #58a6ff; }
  .session-card.selected { border-color: #58a6ff; background: #161b22; }
  .session-card.has-interrupt { border-left: 3px solid #ff4444; }
  .session-card.has-orphan { border-left: 3px solid #ffbb33; }
  .session-card.has-interrupt.has-orphan { border-left: 3px solid #ff4444; border-right: 3px solid #ffbb33; }
  .session-card.is-live { border-left: 3px solid #238636; }
  .session-card.is-stale { border-left: 3px solid #d29922; }
  .live-badge {
    display: inline-block;
    background: #238636;
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 6px;
    text-transform: uppercase;
    vertical-align: middle;
  }
  .stale-badge {
    display: inline-block;
    background: #d29922;
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 6px;
    text-transform: uppercase;
    vertical-align: middle;
  }
  .session-card .sid { font-size: 12px; font-weight: 600; color: #58a6ff; }
  .session-card .cwd { font-size: 10px; color: #8b949e; margin-top: 1px; word-break: break-all; }
  .session-card .stats {
    display: flex;
    gap: 10px;
    margin-top: 3px;
    font-size: 10px;
    color: #8b949e;
  }
  .session-card .stats span { display: flex; align-items: center; gap: 3px; }
  .session-card .stats .warn { color: #ff4444; }
  .session-card .stats .caution { color: #ffbb33; }
  .session-card .stats .ago { color: #484f58; margin-left: auto; }

  /* Tab Bar */
  .tab-bar {
    display: flex;
    gap: 0;
    background: #0d1117;
    border-bottom: 1px solid #30363d;
    flex-shrink: 0;
  }
  .tab-btn {
    font-family: inherit;
    font-size: 11px;
    font-weight: 600;
    padding: 8px 14px;
    border: none;
    background: transparent;
    color: #8b949e;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.15s;
  }
  .tab-btn:hover { color: #c9d1d9; }
  .tab-btn.active { color: #58a6ff; border-bottom-color: #58a6ff; }
  .tab-content {
    padding: 6px;
    overflow-y: auto;
    flex: 1;
  }

  /* Tool Bar Chart (inline bar layout) */
  .tool-row {
    position: relative;
    display: flex;
    align-items: center;
    padding: 0 8px;
    margin-bottom: 3px;
    background: #21262d;
    border-radius: 3px;
    font-size: 12px;
    height: 22px;
    overflow: hidden;
  }
  .tool-row .bar-fill {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    border-radius: 3px;
    transition: width 0.3s;
    z-index: 0;
  }
  .tool-row .bar-fill.green { background: #238636; }
  .tool-row .bar-fill.purple { background: #bb66ff; }
  .tool-row .name {
    position: relative;
    z-index: 1;
    color: #c9d1d9;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }
  .tool-row .count {
    position: relative;
    z-index: 1;
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    flex-shrink: 0;
    margin-left: 8px;
  }

  /* Event Timeline */
  .timeline-filters {
    display: flex;
    gap: 6px;
    padding: 8px 14px;
    flex-wrap: wrap;
    border-bottom: 1px solid #30363d;
    align-items: center;
    flex-shrink: 0;
  }
  .filter-btn {
    font-family: inherit;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #30363d;
    background: #21262d;
    color: #8b949e;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn.active { border-color: #58a6ff; color: #c9d1d9; background: #1f6feb33; }
  .filter-btn:hover { border-color: #58a6ff; }
  .filter-btn.reset-btn {
    border-color: #da3633;
    color: #f85149;
  }
  .filter-btn.reset-btn:hover { background: #da363322; }
  .filter-btn.issues-btn {
    border-color: #d29922;
    color: #d29922;
  }
  .filter-btn.issues-btn:hover { background: #d2992222; }
  .filter-btn.issues-btn.active { background: #d2992233; border-color: #d29922; color: #d29922; }
  .filter-only-btn {
    font-family: inherit;
    font-size: 9px;
    padding: 2px 4px;
    border-radius: 3px;
    border: 1px solid #30363d;
    background: transparent;
    color: #484f58;
    cursor: pointer;
    margin-left: -2px;
  }
  .filter-only-btn:hover { color: #c9d1d9; border-color: #58a6ff; }
  .search-input {
    font-family: inherit;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #30363d;
    background: #0d1117;
    color: #c9d1d9;
    width: 160px;
    margin-left: auto;
  }
  .search-input::placeholder { color: #484f58; }

  /* Event Row */
  .event-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 6px 10px;
    border-bottom: 1px solid #21262d;
    font-size: 12px;
    transition: background 0.15s;
  }
  .event-row:hover { background: #1c2128; }
  .event-row.orphan { border: 1px dashed #ffbb33; border-radius: 4px; margin: 2px 0; }
  .event-row.highlight { background: #1f6feb22; }
  .event-row .time {
    color: #484f58;
    width: 44px;
    flex-shrink: 0;
    font-size: 11px;
    cursor: default;
  }
  .event-row .badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    width: 60px;
    text-align: center;
    flex-shrink: 0;
  }
  .event-row .extra-badge {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    flex-shrink: 0;
  }
  .badge-orphan { background: #ffbb3333; color: #ffbb33; }
  .badge-interrupt { background: #ff444433; color: #ff4444; }
  .event-row .detail { color: #8b949e; flex: 1; word-break: break-all; }
  .event-row .detail .tool { color: #c9d1d9; font-weight: 500; }
  .event-row .session-tag {
    font-size: 10px;
    color: #484f58;
    flex-shrink: 0;
    width: 60px;
    text-align: right;
  }
  .event-row .session-tag.clickable {
    cursor: pointer;
    transition: color 0.15s;
  }
  .event-row .session-tag.clickable:hover {
    color: #58a6ff;
    text-decoration: underline;
  }

  /* Badge Colors */
  .badge-pre { background: #00d4ff22; color: #00d4ff; }
  .badge-post { background: #00ff8822; color: #00ff88; }
  .badge-fail { background: #ff444422; color: #ff4444; }
  .badge-prompt { background: #ffbb3322; color: #ffbb33; }
  .badge-notif { background: #ff884422; color: #ff8844; }
  .badge-stop { background: #aaaaaa22; color: #aaaaaa; }
  .badge-sess-start { background: #ffffff22; color: #ffffff; }
  .badge-sess-end { background: #88888822; color: #888888; }
  .badge-sub-start { background: #bb66ff22; color: #bb66ff; }
  .badge-sub-stop { background: #8844cc22; color: #8844cc; }

  /* Interrupt / Orphan List */
  .issue-item {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 4px;
    padding: 8px 10px;
    margin-bottom: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .issue-item:hover { border-color: #58a6ff; }
  .issue-item.interrupt-item { border-left: 3px solid #ff4444; }
  .issue-item.orphan-item { border-left: 3px solid #ffbb33; }
  .issue-item .issue-label { font-size: 10px; text-transform: uppercase; font-weight: 600; }
  .issue-item .issue-label.red { color: #ff4444; }
  .issue-item .issue-label.yellow { color: #ffbb33; }
  .issue-item .issue-detail { color: #8b949e; margin-top: 2px; }

  .issues-hint {
    font-size: 11px;
    color: #484f58;
    padding: 8px 10px;
    border-bottom: 1px solid #21262d;
    line-height: 1.5;
  }

  .empty-state { color: #484f58; text-align: center; padding: 20px; font-size: 13px; }

  .filter-hint {
    font-size: 11px;
    color: #58a6ff;
    padding: 4px 14px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .filter-hint .clear-filter {
    cursor: pointer;
    color: #f85149;
    font-size: 10px;
  }
  .filter-hint .clear-filter:hover { text-decoration: underline; }

  /* Responsive */
  @media (max-width: 900px) {
    .main { flex-direction: column; height: auto; }
    .left, .right { width: 100%; }
    body { overflow: auto; height: auto; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Hook Events Log Viewer</h1>
  <select id="fileSelect"></select>
  <div class="spacer"></div>
  <button id="refreshBtn" onclick="loadData()">Refresh</button>
  <button id="autoRefreshBtn" onclick="toggleAutoRefresh()">Auto-refresh: OFF</button>
</div>

<div class="stat-bar" id="statBar"></div>

<div class="main">
  <div class="left">
    <div class="panel" style="max-height: 200px; flex-shrink: 0;">
      <div class="panel-title" id="sessionsTitle">Sessions</div>
      <div class="panel-body" id="sessionList"></div>
    </div>
    <div class="panel" style="flex: 1; min-height: 0;">
      <div class="tab-bar" id="leftTabBar">
        <button class="tab-btn active" onclick="switchLeftTab('tools')">Tools</button>
        <button class="tab-btn" onclick="switchLeftTab('skills')">Skills</button>
        <button class="tab-btn" onclick="switchLeftTab('issues')">Issues</button>
      </div>
      <div class="tab-content" id="leftTabContent"></div>
    </div>
  </div>
  <div class="right">
    <div class="panel" style="flex:1; display:flex; flex-direction:column; min-height: 0;">
      <div class="panel-title">Event Timeline</div>
      <div class="timeline-filters" id="timelineFilters"></div>
      <div id="filterHint"></div>
      <div class="panel-body" id="eventTimeline" style="flex:1;"></div>
    </div>
  </div>
</div>

<script>
const EVENT_TYPES = {
  PreToolUse:         { badge: 'Pre',      cls: 'badge-pre' },
  PostToolUse:        { badge: 'Post',     cls: 'badge-post' },
  PostToolUseFailure: { badge: 'Fail',     cls: 'badge-fail' },
  UserPromptSubmit:   { badge: 'Prompt',   cls: 'badge-prompt' },
  Notification:       { badge: 'Notif',    cls: 'badge-notif' },
  Stop:               { badge: 'Stop',     cls: 'badge-stop' },
  SessionStart:       { badge: 'SessStart',cls: 'badge-sess-start' },
  SessionEnd:         { badge: 'SessEnd',  cls: 'badge-sess-end' },
  SubagentStart:      { badge: 'SubStart', cls: 'badge-sub-start' },
  SubagentStop:       { badge: 'SubStop',  cls: 'badge-sub-stop' },
};

let allEvents = [];
let summary = {};
let selectedSession = null;
let activeFilters = new Set(Object.keys(EVENT_TYPES));
let searchText = '';
let autoRefreshId = null;
let lastEventCount = 0;
let activeLeftTab = 'tools';

// -- Data Loading --
async function loadFiles() {
  const res = await fetch('/api/files');
  const { files } = await res.json();
  const sel = document.getElementById('fileSelect');
  sel.innerHTML = files.map(f => `<option value="${f}">${f}</option>`).join('');
  sel.onchange = () => { selectedSession = null; loadData(); };
}

async function loadData() {
  const file = document.getElementById('fileSelect').value || 'hook-events.jsonl';
  const [evRes, sumRes] = await Promise.all([
    fetch(`/api/events?file=${encodeURIComponent(file)}`),
    fetch(`/api/summary?file=${encodeURIComponent(file)}`),
  ]);
  const evData = await evRes.json();
  const sumData = await sumRes.json();
  allEvents = evData.events || [];
  summary = sumData;
  lastEventCount = allEvents.length;
  render();
}

async function checkForUpdates() {
  const file = document.getElementById('fileSelect').value || 'hook-events.jsonl';
  const res = await fetch(`/api/summary?file=${encodeURIComponent(file)}`);
  const data = await res.json();
  if (data.totalEvents !== lastEventCount) {
    loadData();
  }
}

function toggleAutoRefresh() {
  const btn = document.getElementById('autoRefreshBtn');
  if (autoRefreshId) {
    clearInterval(autoRefreshId);
    autoRefreshId = null;
    btn.textContent = 'Auto-refresh: OFF';
    btn.classList.remove('active');
  } else {
    autoRefreshId = setInterval(checkForUpdates, 5000);
    btn.textContent = 'Auto-refresh: ON';
    btn.classList.add('active');
  }
}

// -- Rendering --
function render() {
  renderStatBar();
  renderSessions();
  renderLeftTabContent();
  renderFilters();
  renderFilterHint();
  renderTimeline();
}

function renderStatBar() {
  const s = summary;
  const liveCount = s.liveSessionCount || 0;
  const staleCount = s.staleSessionCount || 0;
  const totalSessions = s.sessionCount || 0;
  const interrupts = s.interruptCount || 0;
  const orphans = s.orphanCount || 0;

  let sessionText = '';
  if (liveCount > 0) sessionText += `<span class="val live">${liveCount} live</span>`;
  if (staleCount > 0) sessionText += `${liveCount ? ' / ' : ''}<span class="val stale">${staleCount} stale</span>`;
  sessionText += `${(liveCount || staleCount) ? ' / ' : ''}<span class="val">${totalSessions}</span> total`;

  document.getElementById('statBar').innerHTML = `
    <div class="stat"><span class="val">${s.totalEvents || 0}</span> events</div>
    <span class="separator">|</span>
    <div class="stat">Sessions: ${sessionText}</div>
    <span class="separator">|</span>
    <div class="stat"><span class="val">${s.toolCount || 0}</span> tools</div>
    <span class="separator">|</span>
    <div class="stat"><span class="val${interrupts ? ' warn' : ''}">${interrupts}</span> interrupts <span class="info-icon" title="Sessions terminated by the stop hook while still active">&#9432;</span></div>
    <span class="separator">|</span>
    <div class="stat"><span class="val${orphans ? ' caution' : ''}">${orphans}</span> orphans <span class="info-icon" title="PreToolUse events that never received a matching PostToolUse response">&#9432;</span></div>
  `;
}

function renderSessions() {
  const el = document.getElementById('sessionList');
  const sessions = sortSessions(summary.sessions || []);
  const titleEl = document.getElementById('sessionsTitle');

  if (selectedSession) {
    const shortSid = selectedSession.slice(0, 8);
    titleEl.innerHTML = `Sessions <span style="color:#58a6ff;font-size:10px;font-weight:400">(filtered: ${shortSid}) <span style="cursor:pointer;color:#f85149" onclick="clearSessionFilter()">&#10005;</span></span>`;
  } else {
    titleEl.textContent = 'Sessions';
  }

  if (!sessions.length) { el.innerHTML = '<div class="empty-state">No sessions found</div>'; return; }
  el.innerHTML = sessions.map(s => {
    const shortId = s.id.slice(0, 8);
    const cls = [
      'session-card',
      selectedSession === s.id ? 'selected' : '',
      s.hasInterrupt ? 'has-interrupt' : '',
      s.orphanCount > 0 ? 'has-orphan' : '',
      s.isLive ? 'is-live' : '',
      s.isStale ? 'is-stale' : '',
    ].filter(Boolean).join(' ');

    let badge = '';
    if (s.isLive) badge = '<span class="live-badge" title="Active within last 5 min">LIVE</span>';
    else if (s.isStale) badge = '<span class="stale-badge" title="No activity for 5+ min">STALE</span>';

    return `
      <div class="${cls}" onclick="selectSession('${s.id}')" id="sess-${s.id.slice(0,8)}">
        <div class="sid">${shortId}${badge}</div>
        <div class="cwd">${esc(s.cwd)}</div>
        <div class="stats">
          <span>${s.eventCount} events</span>
          ${s.hasInterrupt ? '<span class="warn">&#9889; interrupt</span>' : ''}
          ${s.orphanCount > 0 ? `<span class="caution">&#9888; ${s.orphanCount} orphan</span>` : ''}
          <span class="ago">${formatRelativeTime(s.lastTs)} ago</span>
        </div>
      </div>
    `;
  }).join('');
}

function sortSessions(sessions) {
  return [...sessions].sort((a, b) => {
    // live first
    if (a.isLive && !b.isLive) return -1;
    if (!a.isLive && b.isLive) return 1;
    // stale next (with issues first among stale)
    if (a.isStale && !b.isStale) return -1;
    if (!a.isStale && b.isStale) return 1;
    if (a.isStale && b.isStale) {
      const aIssues = (a.hasInterrupt ? 1 : 0) + a.orphanCount;
      const bIssues = (b.hasInterrupt ? 1 : 0) + b.orphanCount;
      if (aIssues !== bIssues) return bIssues - aIssues;
    }
    // then by lastTs desc
    return b.lastTs > a.lastTs ? 1 : -1;
  });
}

function switchLeftTab(tab) {
  activeLeftTab = tab;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase() === tab);
  });
  renderLeftTabContent();
}

function renderLeftTabContent() {
  const el = document.getElementById('leftTabContent');
  switch (activeLeftTab) {
    case 'tools': renderToolUsage(el); break;
    case 'skills': renderSkillUsage(el); break;
    case 'issues': renderIssues(el); break;
  }
}

function renderToolUsage(el) {
  const tools = summary.toolUsage || [];
  if (!tools.length) { el.innerHTML = '<div class="empty-state">No tool usage data</div>'; return; }
  const max = tools[0].count;
  el.innerHTML = tools.map(t => `
    <div class="tool-row">
      <div class="bar-fill green" style="width:${(t.count / max * 100).toFixed(1)}%"></div>
      <span class="name" title="${esc(t.name)}">${esc(t.name)}</span>
      <span class="count">${t.count}</span>
    </div>
  `).join('');
}

function renderSkillUsage(el) {
  const skills = summary.skillUsage || [];
  if (!skills.length) { el.innerHTML = '<div class="empty-state">No skill usage data</div>'; return; }
  const max = skills[0].count;
  el.innerHTML = skills.map(t => `
    <div class="tool-row">
      <div class="bar-fill purple" style="width:${(t.count / max * 100).toFixed(1)}%"></div>
      <span class="name" title="${esc(t.name)}">${esc(t.name)}</span>
      <span class="count">${t.count}</span>
    </div>
  `).join('');
}

function renderIssues(el) {
  const orphanIds = new Set(summary.orphanIds || []);
  const interrupts = allEvents.filter(e => e.event === 'Stop' && e.data?.stop_hook_active);
  const orphans = allEvents.filter(e => e.event === 'PreToolUse' && e.data?.tool_use_id && orphanIds.has(e.data.tool_use_id));

  if (!interrupts.length && !orphans.length) {
    el.innerHTML = '<div class="empty-state">No interrupts or orphans detected</div>';
    return;
  }

  let html = '<div class="issues-hint">Interrupts: sessions terminated by the stop hook while still active<br>Orphans: tool calls without a completion response (interrupted/session ended)</div>';
  for (const ev of interrupts) {
    const idx = allEvents.indexOf(ev);
    html += `
      <div class="issue-item interrupt-item" onclick="scrollToEvent(${idx})">
        <div class="issue-label red">&#9889; Interrupt</div>
        <div class="issue-detail">${formatRelativeTime(ev.ts)} ago &middot; session ${ev.session_id?.slice(0, 8)}</div>
      </div>
    `;
  }
  for (const ev of orphans) {
    const idx = allEvents.indexOf(ev);
    html += `
      <div class="issue-item orphan-item" onclick="scrollToEvent(${idx})">
        <div class="issue-label yellow">&#9888; Orphan Tool Call</div>
        <div class="issue-detail">${esc(ev.data.tool_name)} &middot; ${formatRelativeTime(ev.ts)} ago &middot; session ${ev.session_id?.slice(0, 8)}</div>
      </div>
    `;
  }
  el.innerHTML = html;
}

function renderFilters() {
  const el = document.getElementById('timelineFilters');
  const presentTypes = new Set(allEvents.map(e => e.event));
  let html = '<button class="filter-btn reset-btn" onclick="resetFilters()">Reset</button>';
  html += '<button class="filter-btn issues-btn" onclick="filterIssuesOnly()">&#9888; Issues Only</button>';
  for (const [type, info] of Object.entries(EVENT_TYPES)) {
    if (!presentTypes.has(type)) continue;
    const active = activeFilters.has(type) ? 'active' : '';
    html += `<button class="filter-btn ${active}" onclick="toggleFilter('${type}')">${info.badge}</button>`;
    html += `<button class="filter-only-btn" onclick="filterOnly('${type}')">Only</button>`;
  }
  html += `<input class="search-input" type="text" placeholder="Search..." value="${esc(searchText)}" oninput="onSearch(this.value)">`;
  el.innerHTML = html;
}

function renderFilterHint() {
  const el = document.getElementById('filterHint');
  if (selectedSession) {
    const shortSid = selectedSession.slice(0, 8);
    el.innerHTML = `<div class="filter-hint">Filtered by session: ${shortSid} <span class="clear-filter" onclick="clearSessionFilter()">&#10005; clear</span></div>`;
  } else {
    el.innerHTML = '';
  }
}

function renderTimeline() {
  const el = document.getElementById('eventTimeline');
  const orphanIds = new Set(summary.orphanIds || []);
  const filtered = allEvents.filter((ev, i) => {
    if (!activeFilters.has(ev.event)) return false;
    if (selectedSession && ev.session_id !== selectedSession) return false;
    if (searchText) {
      const haystack = JSON.stringify(ev).toLowerCase();
      if (!haystack.includes(searchText.toLowerCase())) return false;
    }
    return true;
  }).reverse();

  if (!filtered.length) {
    el.innerHTML = '<div class="empty-state">No events match current filters</div>';
    return;
  }

  el.innerHTML = filtered.map(ev => {
    const idx = allEvents.indexOf(ev);
    const info = EVENT_TYPES[ev.event] || { badge: ev.event, cls: 'badge-stop' };
    const isOrphan = ev.event === 'PreToolUse' && ev.data?.tool_use_id && orphanIds.has(ev.data.tool_use_id);
    const isInterrupt = ev.event === 'Stop' && ev.data?.stop_hook_active;
    const rowCls = ['event-row', isOrphan ? 'orphan' : ''].filter(Boolean).join(' ');
    const detail = buildDetail(ev);
    const shortSid = (ev.session_id || '').slice(0, 6);

    let extraBadges = '';
    if (isOrphan) extraBadges += '<span class="extra-badge badge-orphan">ORPHAN</span> ';
    if (isInterrupt) extraBadges += '<span class="extra-badge badge-interrupt">&#9889; INTERRUPT</span> ';

    return `
      <div class="${rowCls}" id="ev-${idx}">
        <span class="time" title="${formatAbsTime(ev.ts)}">${formatRelativeTime(ev.ts)}</span>
        <span class="badge ${info.cls}">${info.badge}</span>
        ${extraBadges}
        <span class="detail">${detail}</span>
        <span class="session-tag clickable" onclick="filterBySession('${ev.session_id || ''}')" title="Filter by this session">${shortSid}</span>
      </div>
    `;
  }).join('');
}

function buildDetail(ev) {
  const d = ev.data || {};
  switch (ev.event) {
    case 'PreToolUse':
      return `<span class="tool">${esc(d.tool_name || '')}</span> ${esc(truncate(d.tool_input_summary || '', 120))}`;
    case 'PostToolUse':
      return `<span class="tool">${esc(d.tool_name || '')}</span> ${d.success ? '&#10004;' : '&#10008;'}`;
    case 'PostToolUseFailure':
      return `<span class="tool">${esc(d.tool_name || '')}</span> &#10008; ${esc(truncate(d.error || '', 100))}`;
    case 'UserPromptSubmit':
      return esc(truncate(d.prompt || d.message || JSON.stringify(d), 150));
    case 'Stop':
      return d.stop_hook_active ? '&#9889; Session interrupted (stop hook)' : esc(truncate(JSON.stringify(d), 120));
    case 'Notification':
      return esc(truncate(d.message || JSON.stringify(d), 150));
    default:
      return esc(truncate(JSON.stringify(d), 150));
  }
}

// -- Interactions --
function selectSession(sid) {
  selectedSession = selectedSession === sid ? null : sid;
  renderSessions();
  renderFilterHint();
  renderTimeline();
}

function filterBySession(sid) {
  if (!sid) return;
  selectedSession = selectedSession === sid ? null : sid;
  renderSessions();
  renderFilterHint();
  renderTimeline();
  // Auto-scroll to session card in left panel
  const sessEl = document.getElementById(`sess-${sid.slice(0, 8)}`);
  if (sessEl) sessEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearSessionFilter() {
  selectedSession = null;
  renderSessions();
  renderFilterHint();
  renderTimeline();
}

function toggleFilter(type) {
  if (activeFilters.has(type)) activeFilters.delete(type);
  else activeFilters.add(type);
  renderFilters();
  renderTimeline();
}

function filterOnly(type) {
  activeFilters.clear();
  activeFilters.add(type);
  renderFilters();
  renderTimeline();
}

function filterIssuesOnly() {
  activeFilters.clear();
  activeFilters.add('Stop');
  activeFilters.add('PreToolUse');
  renderFilters();
  renderTimeline();
}

function resetFilters() {
  activeFilters = new Set(Object.keys(EVENT_TYPES));
  selectedSession = null;
  searchText = '';
  render();
}

function onSearch(val) {
  searchText = val;
  renderTimeline();
}

function scrollToEvent(idx) {
  const el = document.getElementById(`ev-${idx}`);
  if (!el) {
    selectedSession = null;
    activeFilters = new Set(Object.keys(EVENT_TYPES));
    searchText = '';
    renderFilters();
    renderSessions();
    renderFilterHint();
    renderTimeline();
    requestAnimationFrame(() => {
      const el2 = document.getElementById(`ev-${idx}`);
      if (el2) {
        el2.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el2.classList.add('highlight');
        setTimeout(() => el2.classList.remove('highlight'), 2000);
      }
    });
    return;
  }
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  el.classList.add('highlight');
  setTimeout(() => el.classList.remove('highlight'), 2000);
}

// -- Utilities --
function formatRelativeTime(ts) {
  if (!ts) return '';
  const diff = Date.now() - new Date(ts).getTime();
  if (diff < 0) return 'future';
  if (diff < 60000) return 'now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
  return Math.floor(diff / 86400000) + 'd';
}

function formatAbsTime(ts) {
  if (!ts) return '--:--:--';
  const d = new Date(ts);
  return d.toLocaleTimeString('en-US', { hour12: false });
}

function truncate(s, max) {
  return s.length > max ? s.slice(0, max) + '...' : s;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// -- Init --
loadFiles().then(loadData).then(() => {
  autoRefreshId = setInterval(checkForUpdates, 5000);
  document.getElementById('autoRefreshBtn').textContent = 'Auto-refresh: ON';
  document.getElementById('autoRefreshBtn').classList.add('active');
});
</script>
</body>
</html>
